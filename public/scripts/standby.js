// Generated by CoffeeScript 1.9.2
(function() {
  var CHUNK_SIZE, MAX_PINGS,
    slice = [].slice;

  MAX_PINGS = 40;

  CHUNK_SIZE = 5;

  $(function() {
    var $progressbar, addToStandBy, cacheLinks, finishedLoading, hideLink, imageUrl, openLink;
    document.write = function() {
      var p;
      p = 1 <= arguments.length ? slice.call(arguments, 0) : [];
      return console.log(p);
    };
    window.onhashchange = function() {
      var hash;
      hash = window.location.hash.substring(1);
      if (hash) {
        return openLink(hash);
      } else {
        return hideLink();
      }
    };
    $progressbar = $('#progressbar');
    cacheLinks = function() {
      var allElements, curr, i, len, stillInLoading, total, waitForLoaded;
      allElements = $('a.cache:not(.loaded)');
      total = allElements.length;
      curr = 0;
      stillInLoading = true;
      $progressbar.attr('max', total);
      i = 0;
      len = allElements.length;
      while (i < len) {
        (function(els) {
          var urls;
          i += CHUNK_SIZE;
          urls = els.map(function(e) {
            return e.href;
          });
          return $.get('/batch', {
            urls: urls
          }, function(htmls) {
            return _.each(htmls, function(html, index) {
              var $el, el, id, iframe;
              el = els[index];
              $el = $(el);
              console.log("fetched " + el.href);
              id = $el.data('id');
              iframe = document.getElementById(id);
              iframe = iframe.contentWindow || iframe.contentDocument.document || iframe.contentDocument;
              iframe.document.open();
              iframe.document.write(html.replace('window.top.location', 'hahaiwin'));
              iframe.document.close();
              return $el.on('click', function(e) {
                e.preventDefault();
                $(this).addClass('site-link-visited');
                id = $(this).data('id');
                $("#arrow-" + id).addClass('arrow-seen');
                return window.location.hash = id;
              });
            });
          });
        })(allElements.slice(i, i + CHUNK_SIZE).toArray());
      }
      waitForLoaded = function(pings, els) {
        if (pings > MAX_PINGS) {
          stillInLoading = false;
          finishedLoading();
          return;
        }
        _.each(els, function(el, i) {
          var $el, contents, id, pct;
          $el = $(el);
          id = $el.data('id');
          contents = $("#" + id).contents().find('body').html() || '';
          if (contents.length) {
            els.splice(i, 1);
            $el.addClass('loaded');
            curr += 1;
            pct = Math.round(curr / total * 100);
            if (stillInLoading) {
              if (pct === 100) {
                stillInLoading = false;
                return finishedLoading();
              } else if (pct > 95) {
                stillInLoading = false;
                return setTimeout(finishedLoading, 750);
              } else {
                return $progressbar.val(curr);
              }
            }
          }
        });
        if (stillInLoading) {
          return setTimeout(waitForLoaded.bind(null, pings + 1, els), 250);
        }
      };
      return waitForLoaded(0, _.clone(allElements));
    };
    openLink = function(id) {
      $("#" + id).addClass('fucklightboxes');
      $('#x').show();
      return document.body.style.overflow = 'hidden';
    };
    hideLink = function() {
      $('iframe').removeClass('fucklightboxes');
      $('#x').hide();
      return document.body.style.overflow = 'auto';
    };
    $(document).on('keyup', function(e) {
      if ((e.which || e.keyCode) === 27) {
        return window.location.hash = "";
      }
    });
    $('.cache').on('click', function() {
      return false;
    });
    imageUrl = '/images/background.png';
    $('<img/>').attr('src', imageUrl).load(function() {
      $(this).remove();
      $('body').css('background-image', "url(" + imageUrl + ")");
      return cacheLinks();
    });
    $('#x').on('click', function() {
      return window.location.hash = "";
    });
    $('.tab-link').on('click', function(e) {
      var $this, tab;
      $this = $(this);
      tab = $this.data('tab');
      return $("li[data-section='" + tab + "']").click();
    });
    finishedLoading = function() {
      $progressbar.val($progressbar.attr('max'));
      $('#landing').addClass('landing');
      return $('#index').addClass('index');
    };
    $('#icons').delegate('li:not(.add-section)', 'click', function(e) {
      var $this;
      $this = $(this);
      $('#icons li').removeClass('selected');
      $this.addClass('selected');
      $('.content-section').removeClass('active-section');
      return $("#" + ($this.data('section'))).addClass('active-section');
    });
    $('#icons li.add-section').on('click', function(e) {
      return $('.modal').modal();
    });
    $('#modal-subreddit').on('keyup', function(e) {
      if (e.keyCode === 13) {
        addToStandBy("reddit", $('#modal-subreddit').val());
        $('.modal').modal('hide');
        return $('#modal-subreddit').val('');
      }
    });
    $('.modal-producthunt').on('click', function(e) {
      addToStandBy("producthunt");
      return $('.modal').modal('hide');
    });
    return addToStandBy = function(service, subreddit) {
      if (subreddit == null) {
        subreddit = "";
      }
      return $.get('/add', {
        service: service,
        subreddit: subreddit
      }, function(posts) {
        var $newTab, html, img, section;
        section = subreddit || service;
        section += "-section";
        img = subreddit ? "Reddit_on.png" : "Product_on.png";
        $newTab = $("<li data-section='" + section + "'><img src='/images/" + img + "'></li>");
        $('#icons .add-section').before($newTab);
        html = "<div id='" + section + "' class='content-section'>";
        posts.forEach(function(post, i) {
          if (subreddit) {
            return html += "<div>\n  <div class='section-link'>\n    <div class='upvotes'>\n      <div class='arrow' id=\"arrow-" + section + "-link-" + i + "\"></div>\n      <div>" + post.score + "</div>\n    </div>\n    <div class='post-data'>\n      <a class='cache site-link' data-id='" + section + "-link-" + i + "' href='" + post.url + "'>" + post.title + "</a>\n      <span class='website'>(" + (post.url.replace('http://', '').replace('https://', '').split(/[\/?#]/)[0]) + ")</span>\n      <a class='cache comments' data-id='" + section + "-comments-" + i + "' href='http://reddit.com" + post.permalink + "'>" + post.num_comments + " comments\n      </a>\n    </div>\n  </div>\n  <iframe sandbox=\"allow-same-origin\" class='content' id='" + section + "-link-" + i + "'></iframe>\n  <iframe class='content' id='" + section + "-comments-" + i + "'></iframe>\n</div>";
          } else {
            return html += "<div>\n  <div class='section-link'>\n    <div class='upvotes'>\n      <div class='arrow'></div>\n      <div>" + post.votes + "</div>\n    </div>\n    <div class='post-data'>\n      <a class='cache site-link' data-id='product-hunt-link-" + i + "' href='" + post.url + "'>" + post.title + "</a>\n      <span class='website'>(" + (post.url.replace('http://', '').replace('https://', '').split(/[\/?#]/)[0]) + ")</span>\n      <a class='cache comments' data-id='product-hunt-comments-" + i + "' href='http://producthunt.com" + post.permalink + "'>" + post.comment_count + " comments</a>\n    </div>\n  </div>\n  <iframe sandbox=\"allow-same-origin\" class='content' id='product-hunt-link-" + i + "'></iframe>\n  <iframe class='content' id='product-hunt-comments-" + i + "'></iframe>\n</div>";
          }
        });
        html += "</div>";
        $('#content-section-wrap').append(html);
        $newTab.click();
        return cacheLinks();
      });
    };
  });

}).call(this);
